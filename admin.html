<!DOCTYPE html>

<html class="light" lang="en">

<head>
    <script>
        // Authentication Check - MUST RUN BEFORE ANYTHING ELSE
        if (sessionStorage.getItem('donero_admin_auth') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Donero Cafe - Admin Console</title>
    <!-- Tailwind CSS (v4) -->
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
        --color-primary: #EDA747;
        --color-background-light: #fafafa;
        --font-display: "Epilogue", sans-serif;
        --font-handwritten: "Gloria Hallelujah", cursive;
        --radius-default: 0.25rem;
        --radius-lg: 0.5rem;
        --radius-xl: 0.75rem;
        --radius-full: 9999px;
    }
    @layer base {
        body {
            @apply bg-background-light text-slate-900 antialiased;
            font-family: var(--font-display);
        }
    }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .material-symbols-outlined {
        font-family: 'Material Symbols Outlined' !important;
        font-display: block;
    }
</style>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Epilogue:wght@100..900&family=Gloria+Hallelujah&display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-background-light text-slate-900 antialiased font-display">
    <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
        <!-- Top Navigation Bar -->
        <header
            class="flex items-center justify-between border-b border-primary/10 bg-white px-6 py-3 sticky top-0 z-50 shadow-sm">
            <div class="flex items-center gap-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary flex items-center justify-center rounded-lg text-white">
                        <span class="material-symbols-outlined text-2xl font-bold">coffee</span>
                    </div>
                    <div>
                        <h2 class="text-xl font-handwritten font-bold leading-tight tracking-tight text-primary">
                            Donero Cafe</h2>
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none">Admin
                            Console</p>
                    </div>
                </div>
                <div
                    class="hidden md:flex items-center bg-slate-100 rounded-lg px-3 py-1.5 ml-4 relative transition-all">
                    <span class="material-symbols-outlined text-slate-500 text-sm mr-2">search</span>
                    <input id="search-input"
                        class="bg-transparent border-none focus:ring-0 focus:outline-none text-sm w-64 placeholder:text-slate-400"
                        placeholder="Search orders, tables, items..." type="text" />
                    <button id="clear-search"
                        class="hidden absolute right-2 top-1/2 -translate-y-1/2 p-1 text-slate-400 hover:text-red-500 transition-colors">
                        <span class="material-symbols-outlined text-xs">close</span>
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <a href="https://menubanao.github.io/Donero-Cafe/"
                    class="hidden sm:flex items-center gap-2 bg-primary/5 text-primary border border-primary/20 hover:bg-primary/10 px-4 py-2 rounded-lg transition-all text-sm font-bold shadow-sm">
                    <span class="material-symbols-outlined text-lg">restaurant_menu</span>
                    View Live Menu
                </a>
                <div class="flex items-center gap-3">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold">Kunal sir</p>
                        <p class="text-[10px] text-slate-500 uppercase font-bold tracking-wider">App Owner</p>
                    </div>
                    <div
                        class="h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center overflow-hidden border-2 border-primary/20">
                        <img class="h-full w-full object-cover" data-alt="Profile photo of the cafe administrator"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDuMVyxKYlfSqsyfWa4ESusD7pJPEU2kYkxL0VLKpGUgCbpd3zuIcYolqNHCH_t4CUGsWqOS5az7FYX8T26_qH7GWTK5MsURu6lS9pZ2cx72KQfg-4W7Y-ZV4LurM7HVMUClQeJt9nT6ayUwhTrrLfOVJtjBeGZBK8caPhp5Ak4ByuqiAoVUeSvso3d0FCRplprZPOArWeqfEqih_UV-gKVYenAeTpEZGQr6UwWsg4I_n0eDFxsqDfPErRLZ7H6vSuAT50O5VE3R4Y" />
                    </div>
                    <!-- Logout Button -->
                    <button onclick="logoutAdmin()"
                        class="flex items-center justify-center p-2 text-slate-400 hover:text-red-500 transition-colors"
                        title="Logout">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
        </header>
        <!-- Status Filter Bar -->
        <nav class="bg-white border-b border-primary/10 px-6 overflow-x-auto whitespace-nowrap scrollbar-hide">
            <div id="filter-nav" class="flex gap-8">
                <button
                    class="filter-btn flex flex-col items-center border-b-2 border-primary py-2 px-2 hover:border-primary/50 transition-colors"
                    data-status="ALL">
                    <span class="text-sm font-bold text-primary flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">list_alt</span>
                        All Live <span id="count-all"
                            class="bg-primary/10 text-primary px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </span>
                </button>
                <button
                    class="filter-btn flex flex-col items-center border-b-2 border-transparent py-2 px-2 hover:border-primary/50 transition-colors"
                    data-status="NEW">
                    <span class="text-sm font-bold text-slate-500 hover:text-primary flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">new_releases</span>
                        New <span id="count-new"
                            class="bg-primary/10 text-primary px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </span>
                </button>
                <button
                    class="filter-btn flex flex-col items-center border-b-2 border-transparent py-2 px-2 hover:border-primary/50 transition-colors"
                    data-status="PREPARING">
                    <span class="text-sm font-bold text-slate-500 hover:text-primary flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">cooking</span>
                        Preparing <span id="count-preparing"
                            class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </span>
                </button>
                <button
                    class="filter-btn flex flex-col items-center border-b-2 border-transparent py-2 px-2 hover:border-primary/50 transition-colors"
                    data-status="READY">
                    <span class="text-sm font-bold text-slate-500 hover:text-primary flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">check_circle</span>
                        Ready <span id="count-ready"
                            class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </span>
                </button>
                <button
                    class="filter-btn flex flex-col items-center border-b-2 border-transparent py-2 px-2 hover:border-primary/50 transition-colors"
                    data-status="SERVED">
                    <span class="text-sm font-bold text-slate-500 hover:text-primary flex items-center gap-2">
                        <span class="material-symbols-outlined text-sm">delivery_dining</span>
                        Served <span id="count-served"
                            class="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px]">0</span>
                    </span>
                </button>
            </div>
        </nav>
        <main class="flex-1 px-6 pt-2 pb-6 space-y-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-black tracking-tight uppercase">Live Orders Panel</h1>
                <div class="flex items-center gap-3">
                    <div id="live-connection"
                        class="flex items-center text-xs font-semibold text-green-600 bg-green-50 px-2.5 py-1 rounded-full border border-green-200">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                        Live Connection Active
                    </div>
                    <button onclick="fetchInitialOrders()"
                        class="bg-white border border-slate-200 text-slate-600 px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-slate-50 transition-all shadow-sm">
                        <span class="material-symbols-outlined text-sm">refresh</span>
                    </button>
                    <button id="manual-entry-btn"
                        class="bg-primary shadow-lg shadow-primary/20 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-primary/90 transition-all">
                        <span class="material-symbols-outlined text-sm">add</span>
                        Manual Entry
                    </button>
                </div>
            </div>
            <!-- Orders Grid -->
            <div id="orders-grid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-6 min-h-[400px]">
                <!-- Dynamic Content -->
            </div>
            <!-- Dashboard Stats Summary -->
            <section class="mt-8 border-t border-slate-200 pt-8">
                <h2 class="text-lg font-bold mb-4">Daily Performance Summary</h2>
                <div id="stats-summary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Dynamic Content -->
                </div>
            </section>
        </main>
        <!-- Floating Action Button for Mobile -->
        <button onclick="openManualEntryModal()"
            class="fixed bottom-6 right-6 lg:hidden bg-primary text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center">
            <span class="material-symbols-outlined">add</span>
        </button>

        <!-- Manual Entry Modal -->
        <div id="manual-entry-modal"
            class="hidden fixed inset-0 z-[100] bg-slate-900/40 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
                <div class="p-6 border-b border-slate-100 flex items-center justify-between">
                    <h2 id="modal-title" class="text-xl font-bold flex items-center gap-2 text-slate-800">
                        <span class="material-symbols-outlined text-primary">add_shopping_cart</span>
                        Create Manual Order
                    </h2>
                    <button onclick="closeManualEntryModal()"
                        class="text-slate-400 hover:text-slate-600 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <form id="manual-order-form" class="flex-1 overflow-y-auto p-6 space-y-6 scrollbar-hide">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Customer
                                Name</label>
                            <input type="text" id="modal-customer" required
                                class="w-full bg-slate-50 border-none rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary shadow-sm text-sm"
                                placeholder="e.g. John Doe">
                        </div>
                        <div>
                            <label
                                class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Table/Type</label>
                            <select id="modal-table" required
                                class="w-full bg-slate-50 border-none rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary shadow-sm text-sm">
                                <option value="">Select Table...</option>
                                <option value="Takeaway">Takeaway</option>
                                <option value="01">Table 01</option>
                                <option value="02">Table 02</option>
                                <option value="03">Table 03</option>
                                <option value="04">Table 04</option>
                                <option value="05">Table 05</option>
                                <option value="06">Table 06</option>
                                <option value="07">Table 07</option>
                                <option value="08">Table 08</option>
                                <option value="09">Table 09</option>
                                <option value="10">Table 10</option>
                                <option value="11">Table 11</option>
                                <option value="12">Table 12</option>
                                <option value="13">Table 13</option>
                                <option value="14">Table 14</option>
                                <option value="15">Table 15</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Quick Add
                            Common Items</label>
                        <div class="flex flex-wrap gap-2">
                            <button type="button" onclick="quickAddItem('Coffee', 60)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">‚òï
                                Coffee</button>
                            <button type="button" onclick="quickAddItem('Tea', 40)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">üçµ
                                Tea</button>
                            <button type="button" onclick="quickAddItem('Burger', 120)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">üçî
                                Burger</button>
                            <button type="button" onclick="quickAddItem('Pizza', 250)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">üçï
                                Pizza</button>
                            <button type="button" onclick="quickAddItem('Pasta', 180)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">üçù
                                Pasta</button>
                            <button type="button" onclick="quickAddItem('Fries', 90)"
                                class="px-3 py-1.5 bg-slate-100 rounded-lg text-xs font-bold hover:bg-primary/10 hover:text-primary transition-colors border border-slate-200 text-slate-700">üçü
                                Fries</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="text-xs font-bold text-slate-500 uppercase tracking-widest">Order
                                Items</label>
                            <button type="button" onclick="addItemToForm()"
                                class="text-primary text-xs font-bold border border-primary/20 bg-primary/5 px-3 py-1.5 rounded-lg hover:bg-primary/10 transition-colors flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">add</span> Add Item
                            </button>
                        </div>
                        <div id="modal-items-list" class="space-y-3">
                            <!-- Items injected here -->
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-1.5">Special
                            Notes (Optional)</label>
                        <textarea id="modal-notes" rows="2"
                            class="w-full bg-slate-50 border-none rounded-lg px-4 py-2.5 focus:ring-2 focus:ring-primary shadow-sm text-sm"
                            placeholder="Add any special requests..."></textarea>
                    </div>
                </form>

                <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex items-center justify-between">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total Amount</p>
                        <p class="text-2xl font-black text-primary" id="modal-total">‚Çπ0.00</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" onclick="clearManualForm()"
                            class="px-4 py-2.5 rounded-lg text-sm font-bold text-red-500 hover:bg-red-50 transition-colors border border-red-100">Reset</button>
                        <button type="button" onclick="closeManualEntryModal()"
                            class="px-6 py-2.5 rounded-lg text-sm font-bold text-slate-500 hover:bg-slate-200 transition-colors">Cancel</button>
                        <button type="submit" form="manual-order-form"
                            class="bg-primary shadow-lg shadow-primary/20 text-white px-8 py-2.5 rounded-lg text-sm font-bold hover:bg-primary/90 transition-all">Create
                            Order</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Iframe for Printing -->
    <iframe id="print-frame" style="display:none;"></iframe>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vuqvokufivgtevpvppcd.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_-957Cp2j5PH0VkWJH9XdmQ_wf2WqLMN';
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- Data State ---
        let MOCK_ORDERS = []; // Will be populated from Supabase

        const MOCK_STATS = {
            revenue: '‚Çπ0.00',
            todayRevenue: '‚Çπ0.00',
            revenueTrend: '+0%',
            totalOrders: 0,
            todayOrders: 0,
            cancelled: 0
        };

        // --- State Management ---
        let currentFilter = 'ALL';
        let searchQuery = '';
        let formItems = []; // For Manual Entry Form
        let editingOrderId = null; // Track if we are editing an order

        // --- Modal Logic ---
        function openManualEntryModal() {
            editingOrderId = null;
            const modal = document.getElementById('manual-entry-modal');
            const title = document.getElementById('modal-title');

            title.innerHTML = `<span class="material-symbols-outlined text-primary">add_shopping_cart</span> Create Manual Order`;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Reset form
            document.getElementById('manual-order-form').reset();
            formItems = [];
            addItemToForm(); // Start with one item
        }

        function editOrder(id) {
            const order = MOCK_ORDERS.find(o => o.id === id);
            if (!order) return;

            editingOrderId = id;
            const modal = document.getElementById('manual-entry-modal');
            const title = document.getElementById('modal-title');

            title.innerHTML = `<span class="material-symbols-outlined text-primary">edit_note</span> Modify Order #${id}`;
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';

            // Populate form
            document.getElementById('modal-customer').value = order.customer;
            document.getElementById('modal-table').value = order.table;
            document.getElementById('modal-notes').value = order.notes || '';

            formItems = order.items.map(item => ({
                id: Date.now() + Math.random(),
                name: item.name,
                qty: item.qty,
                price: item.price
            }));

            renderFormItems();
        }

        function closeModal() {
            // Alias for the existing closeModal if needed, but we'll use closeManualEntryModal for clarity
            closeManualEntryModal();
        }

        function closeManualEntryModal() {
            const modal = document.getElementById('manual-entry-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        function clearManualForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                document.getElementById('manual-order-form').reset();
                formItems = [];
                addItemToForm();
                calculateFormTotal();
            }
        }

        function addItemToForm() {
            const id = Date.now() + Math.random();
            formItems.push({ id, name: '', qty: 1, price: 0 });
            renderFormItems();
        }

        function removeItemFromForm(id) {
            formItems = formItems.filter(item => item.id !== id);
            renderFormItems();
        }

        function updateFormItem(id, field, value) {
            const item = formItems.find(i => i.id === id);
            if (item) {
                if (field === 'price' || field === 'qty') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
                calculateFormTotal();
            }
        }

        function calculateFormTotal() {
            const total = formItems.reduce((sum, item) => sum + (item.qty * item.price), 0);
            document.getElementById('modal-total').textContent = `‚Çπ${total.toFixed(2)}`;
        }

        function renderFormItems() {
            const list = document.getElementById('modal-items-list');
            if (formItems.length === 0) {
                list.innerHTML = `<p class="text-center text-slate-400 text-xs py-4 border-2 border-dashed border-slate-100 rounded-xl">No items added yet. Use "Add Item" or "Quick Add".</p>`;
            } else {
                list.innerHTML = formItems.map(item => `
                    <div class="flex items-center gap-3 bg-slate-50 p-3 rounded-xl border border-slate-100 group">
                        <div class="flex-1">
                            <input type="text" value="${item.name}" oninput="updateFormItem(${item.id}, 'name', this.value)" required
                                class="w-full bg-white border-slate-200 rounded-lg px-3 py-1.5 text-sm focus:ring-1 focus:ring-primary" placeholder="Item Name">
                        </div>
                        <div class="w-16">
                            <input type="number" value="${item.qty}" min="1" oninput="updateFormItem(${item.id}, 'qty', this.value)" required
                                class="w-full bg-white border-slate-200 rounded-lg px-2 py-1.5 text-sm focus:ring-1 focus:ring-primary text-center" placeholder="Qty">
                        </div>
                        <div class="w-24 relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs">‚Çπ</span>
                            <input type="number" step="0.01" value="${item.price}" oninput="updateFormItem(${item.id}, 'price', this.value)" required
                                class="w-full bg-white border-slate-200 rounded-lg pl-6 pr-3 py-1.5 text-sm focus:ring-1 focus:ring-primary" placeholder="Price">
                        </div>
                        <button type="button" onclick="removeItemFromForm(${item.id})" class="text-slate-300 hover:text-red-500 transition-colors">
                            <span class="material-symbols-outlined text-lg">delete</span>
                        </button>
                    </div>
                `).join('');
            }
            calculateFormTotal();
        }

        function quickAddItem(name, price) {
            const existing = formItems.find(i => i.name === name);
            if (existing) {
                existing.qty += 1;
            } else {
                const id = Date.now() + Math.random();
                formItems.push({ id, name, qty: 1, price });
            }
            renderFormItems();
        }

        // --- Rendering Logic ---
        function renderOrders() {
            const grid = document.getElementById('orders-grid');
            const filterBtns = document.querySelectorAll('.filter-btn');

            // Update Filter UI
            filterBtns.forEach(btn => {
                if (btn.dataset.status === currentFilter) {
                    btn.classList.add('border-primary');
                    btn.classList.remove('border-transparent');
                    btn.querySelector('span').classList.add('text-primary');
                    btn.querySelector('span').classList.remove('text-slate-500');
                } else {
                    btn.classList.remove('border-primary');
                    btn.classList.add('border-transparent');
                    btn.querySelector('span').classList.remove('text-primary');
                    btn.querySelector('span').classList.add('text-slate-500');
                }
            });

            // Filter Orders
            const q = searchQuery.toLowerCase();
            const liveStatuses = ['NEW', 'PREPARING', 'READY'];

            let filtered = MOCK_ORDERS.filter(o => {
                const matchesStatus = currentFilter === 'ALL'
                    ? liveStatuses.includes(o.status)
                    : o.status === currentFilter;

                const matchesSearch = o.customer.toLowerCase().includes(q) ||
                    o.id.toLowerCase().includes(q) ||
                    o.table.toLowerCase().includes(q) ||
                    o.items.some(item => item.name.toLowerCase().includes(q));
                return matchesStatus && matchesSearch;
            });

            // Update Counts
            document.getElementById('count-all').textContent = MOCK_ORDERS.filter(o => liveStatuses.includes(o.status)).length;
            document.getElementById('count-new').textContent = MOCK_ORDERS.filter(o => o.status === 'NEW').length;
            document.getElementById('count-preparing').textContent = MOCK_ORDERS.filter(o => o.status === 'PREPARING').length;
            document.getElementById('count-ready').textContent = MOCK_ORDERS.filter(o => o.status === 'READY').length;
            document.getElementById('count-served').textContent = MOCK_ORDERS.filter(o => o.status === 'SERVED' || o.status === 'PAID').length;


            if (filtered.length === 0) {
                grid.innerHTML = `
                <div class="col-span-full bg-white/50 rounded-xl border-2 border-dashed border-slate-200 flex flex-col items-center justify-center p-8 text-center min-h-[400px]">
                    <span class="material-symbols-outlined text-4xl text-slate-300 mb-2">pending_actions</span>
                    <p class="text-slate-400 font-medium">No orders found matching your criteria...</p>
                    <p class="text-[10px] text-slate-300 mt-1">Updates in real-time</p>
                </div>
            `;
                return;
            }

            grid.innerHTML = filtered.map(order => createOrderCard(order)).join('');

            // Add event listeners to buttons
            grid.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const action = e.currentTarget.dataset.action;
                    const id = e.currentTarget.dataset.id;
                    handleAction(id, action);
                });
            });
        }

        function createOrderCard(order) {
            const statusCfg = {
                NEW: { label: 'New Order', border: 'border-primary', bg: 'bg-primary/10', color: 'text-primary' },
                PREPARING: { label: 'Preparing', border: 'border-yellow-500', bg: 'bg-yellow-50', color: 'text-yellow-700' },
                READY: { label: 'Ready', border: 'border-green-500', bg: 'bg-green-50', color: 'text-green-700' },
                SERVED: { label: 'Served', border: 'border-slate-400', bg: 'bg-slate-50', color: 'text-slate-600' },
                PAID: { label: 'Paid', border: 'border-slate-800', bg: 'bg-slate-100', color: 'text-slate-800' }
            };
            const cfg = statusCfg[order.status];

            return `
            <div class="bg-white rounded-xl shadow-md border-l-4 ${cfg.border} overflow-hidden flex flex-col">
                <div class="p-4 border-b border-primary/5 flex justify-between items-start">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="${cfg.bg} ${cfg.color} text-[10px] font-black uppercase px-2 py-0.5 rounded tracking-widest">${cfg.label}</span>
                            <span class="text-slate-400 text-xs font-medium">#${order.id}</span>
                        </div>
                        <h3 class="text-lg font-bold leading-none">Table ${order.table}</h3>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-bold text-primary">‚Çπ${order.total.toFixed(2)}</p>
                        <p class="text-[10px] text-slate-400">${order.time}</p>
                    </div>
                </div>
                <div class="p-4 flex-1 space-y-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-400">
                            <span class="material-symbols-outlined text-sm">person</span>
                        </div>
                        <div>
                            <p class="text-xs text-slate-500 leading-none mb-0.5">Customer</p>
                            <p class="text-sm font-bold">${order.customer}</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-tighter">Items</p>
                        <div class="space-y-1.5">
                            ${order.items.map(it => `
                                <div class="flex justify-between items-center text-sm">
                                    <span class="flex items-center gap-2">
                                        <b>${it.qty}x</b> ${it.name}
                                    </span>
                                    <span class="text-slate-400">‚Çπ${(it.qty * it.price).toFixed(2)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ${order.notes ? `
                        <div class="bg-primary/5 rounded-lg p-3 border border-primary/10">
                            <p class="text-xs font-bold text-primary uppercase mb-1 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">description</span> Special Notes
                            </p>
                            <p class="text-xs italic text-slate-600">"${order.notes}"</p>
                        </div>
                    ` : ''}
                    ${order.status === 'PREPARING' ? `
                        <div class="border-t border-slate-100 pt-4">
                            <div class="flex items-center justify-between text-xs font-medium text-slate-500">
                                <span>Preparation Progress</span>
                                <span>${order.progress}%</span>
                            </div>
                            <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                                <div class="bg-yellow-500 h-1.5 rounded-full" style="width: ${order.progress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    ${order.status === 'READY' ? `
                        <div class="bg-green-50 rounded-lg p-3 border border-green-100 flex items-center gap-3">
                            <span class="material-symbols-outlined text-green-600">notifications_active</span>
                            <p class="text-xs text-green-800 font-medium">Customer has been notified for pickup.</p>
                        </div>
                    ` : ''}
                </div>
                <div class="bg-slate-50 p-4 grid grid-cols-2 gap-2">
                    ${getActionButtons(order)}
                    <button onclick="printOrderTicket('${order.id}')" class="bg-white border border-slate-200 text-slate-600 font-bold py-2 px-3 rounded text-sm hover:bg-slate-50 transition-colors flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined text-base">print</span> Ticket
                    </button>
                    ${order.status !== 'CANCELLED' ? `
                        <div class="col-span-2 flex gap-2 mt-1">
                            <button class="flex-1 text-red-500 font-bold py-1.5 text-xs hover:bg-red-50 transition-colors border border-red-100 rounded bg-white flex items-center justify-center gap-1" data-id="${order.id}" data-action="CANCEL">
                                <span class="material-symbols-outlined text-[14px]">cancel</span> Cancel
                            </button>
                            <button onclick="editOrder('${order.id}')" class="flex-1 text-slate-400 font-bold py-1.5 text-xs hover:bg-slate-50 transition-colors border border-slate-100 rounded bg-white flex items-center justify-center gap-1">
                                <span class="material-symbols-outlined text-[14px]">edit</span> Edit
                            </button>
                        </div>
                    ` : `
                        <p class="col-span-2 text-center text-[10px] text-slate-400 font-bold uppercase py-2">Order Cancelled</p>
                    `}
                </div>
            </div>
        `;
        }

        function getActionButtons(order) {
            if (order.status === 'NEW') {
                return `<button data-id="${order.id}" data-action="PREPARING" class="bg-primary text-white font-bold py-2 px-3 rounded text-sm hover:bg-primary/90 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-base">play_arrow</span> Accept
            </button>`;
            }
            if (order.status === 'PREPARING') {
                return `<button data-id="${order.id}" data-action="READY" class="bg-yellow-500 text-white font-bold py-2 px-3 rounded text-sm hover:bg-yellow-600 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-base">check_circle</span> Mark Ready
            </button>`;
            }
            if (order.status === 'READY') {
                return `<button data-id="${order.id}" data-action="SERVED" class="bg-green-500 text-white font-bold py-2 px-3 rounded text-sm hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                <span class="material-symbols-outlined text-base">delivery_dining</span> Mark Served
            </button>`;
            }
            return '';
        }

        function renderStats() {
            const statsContainer = document.getElementById('stats-summary');
            const stats = [
                {
                    title: "Today's Earning",
                    value: MOCK_STATS.todayRevenue,
                    subtext: `Total Revenue: ${MOCK_STATS.revenue}`,
                    icon: "payments",
                    color: "primary"
                },
                {
                    title: "Orders Volume",
                    value: MOCK_STATS.todayOrders,
                    subtext: `Total Orders: ${MOCK_STATS.totalOrders}`,
                    icon: "list_alt",
                    color: "slate-900"
                }
            ];

            statsContainer.innerHTML = stats.map(stat => `
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col justify-between">
                <div>
                    <p class="text-slate-500 text-[10px] font-bold uppercase mb-1">${stat.title}</p>
                    <h4 class="text-2xl font-black ${stat.color === 'primary' ? 'text-primary' : ''}" style="${stat.color !== 'primary' ? `color: ${stat.color}` : ''}">${stat.value}</h4>
                </div>
                ${stat.subtext ? `<p class="text-[10px] font-bold text-slate-400 mt-2 uppercase tracking-tight">${stat.subtext}</p>` : ''}
            </div>
        `).join('');
        }

        async function handleAction(id, action) {
            if (action === 'CANCEL') {
                if (confirm('Are you sure you want to cancel this order?')) {
                    const { error } = await sbClient
                        .from('orders')
                        .update({ status: 'CANCELLED' })
                        .eq('id', id);

                    if (error) {
                        console.error('Error cancelling order:', error);
                        alert('Failed to cancel order.');
                    }
                }
                return;
            }

            // Update status in Supabase
            const updates = { status: action };
            if (action === 'PREPARING') updates.progress = 0;

            const { error } = await sbClient
                .from('orders')
                .update(updates)
                .eq('id', id);

            if (error) {
                console.error('Error updating order:', error);
                alert('Failed to update status.');
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Modal Hook
            document.getElementById('manual-entry-btn').addEventListener('click', openManualEntryModal);

            // Form Submission
            document.getElementById('manual-order-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const orderData = {
                    customer: document.getElementById('modal-customer').value,
                    table_no: document.getElementById('modal-table').value,
                    items: formItems.map(i => ({ name: i.name, qty: i.qty, price: i.price })),
                    total: formItems.reduce((sum, item) => sum + (item.qty * item.price), 0),
                    notes: document.getElementById('modal-notes').value,
                    status: 'NEW',
                    payment: 'Cash (Unpaid)'
                };

                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerText = 'Syncing...';

                try {
                    console.log("Submitting order data:", orderData);
                    if (editingOrderId) {
                        const { error } = await sbClient
                            .from('orders')
                            .update(orderData)
                            .eq('id', editingOrderId);
                        if (error) throw error;
                        alert(`Order ${editingOrderId} updated successfully!`);
                    } else {
                        const newOrder = {
                            id: `ORD-${Math.floor(1000 + Math.random() * 9000)}`,
                            ...orderData,
                            created_at: new Date().toISOString()
                        };
                        const { error } = await sbClient
                            .from('orders')
                            .insert([newOrder]);
                        if (error) throw error;
                        alert(`Order ${newOrder.id} created successfully!`);
                    }
                    closeManualEntryModal();
                } catch (err) {
                    console.error('Submission error details:', err);
                    const msg = err.message || err.details || "Check console for details";
                    alert(`Failed to sync with database: ${msg}`);
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerText = editingOrderId ? 'Update Order' : 'Create Order';
                }
            });

            // Filter Event Listeners
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentFilter = btn.dataset.status;
                    renderOrders();
                });
            });

            // Search Event Listener
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search');

            searchInput.addEventListener('input', (e) => {
                searchQuery = e.target.value;
                clearBtn.classList.toggle('hidden', !searchQuery);
                renderOrders();
            });

            clearBtn.addEventListener('click', () => {
                searchQuery = '';
                searchInput.value = '';
                clearBtn.classList.add('hidden');
                searchInput.focus();
                renderOrders();
            });

            // Initial Render
            renderOrders();
            renderStats();

            // Start everything
            fetchInitialOrders();
            setupRealtimeListener();
        });

        // --- Realtime and Initial Fetch ---
        async function fetchInitialOrders() {
            const refreshBtn = document.querySelector('button[onclick="fetchInitialOrders()"]');
            if (refreshBtn) refreshBtn.querySelector('span').classList.add('animate-spin');

            try {
                const { data, error } = await sbClient
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Fetch error:', error);
                    return;
                }

                MOCK_ORDERS = data.map(o => ({
                    ...o,
                    table: o.table_no, // Mapping DB naming to UI naming
                    time: formatDbDate(o.created_at)
                }));
                updateStatsFromData();
                renderOrders();
                renderStats();
            } finally {
                if (refreshBtn) {
                    setTimeout(() => refreshBtn.querySelector('span').classList.remove('animate-spin'), 500);
                }
            }
        }

        function setupRealtimeListener() {
            sbClient
                .channel('orders_channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, (payload) => {
                    console.log('Change received!', payload);

                    if (payload.eventType === 'INSERT') {
                        const newOrder = {
                            ...payload.new,
                            table: payload.new.table_no,
                            time: 'Just now'
                        };
                        MOCK_ORDERS.unshift(newOrder);
                        showLiveNotification(`New order from ${newOrder.customer}!`);
                    } else if (payload.eventType === 'UPDATE') {
                        const index = MOCK_ORDERS.findIndex(o => o.id === payload.new.id);
                        if (index !== -1) {
                            MOCK_ORDERS[index] = {
                                ...MOCK_ORDERS[index],
                                ...payload.new,
                                table: payload.new.table_no
                            };
                        }
                    } else if (payload.eventType === 'DELETE') {
                        MOCK_ORDERS = MOCK_ORDERS.filter(o => o.id !== payload.old.id);
                    }

                    updateStatsFromData();
                    renderOrders();
                    renderStats();
                })
                .subscribe();
        }

        function formatDbDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} mins ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hours ago`;
            return date.toLocaleDateString();
        }

        async function updateStatsFromData() {
            const today = new Date().toLocaleDateString();
            const liveOrders = MOCK_ORDERS.filter(o => o.status !== 'CANCELLED');

            const servedCount = liveOrders.filter(o => o.status === 'SERVED' || o.status === 'PAID').length;
            const revenue = liveOrders.reduce((sum, o) => sum + (o.total || 0), 0);

            const todayOrders = liveOrders.filter(o => {
                const orderDate = new Date(o.created_at).toLocaleDateString();
                return orderDate === today;
            });

            const todayRevenueAmount = todayOrders.reduce((sum, o) => sum + (o.total || 0), 0);
            const cancelledCount = MOCK_ORDERS.filter(o => o.status === 'CANCELLED').length;

            MOCK_STATS.totalOrders = liveOrders.length;
            MOCK_STATS.todayOrders = todayOrders.length;
            MOCK_STATS.revenue = `‚Çπ${revenue.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            MOCK_STATS.todayRevenue = `‚Çπ${todayRevenueAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            MOCK_STATS.cancelled = cancelledCount;

            // Update Connection Badge (Real Health Check)
            const badge = document.getElementById('live-connection');
            if (badge) {
                try {
                    const { error } = await sbClient.from('orders').select('id', { count: 'exact', head: true }).limit(1);
                    if (!error) {
                        badge.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span> Live Connection Active`;
                        badge.className = 'flex items-center text-xs font-semibold text-green-600 bg-green-50 px-2.5 py-1 rounded-full border border-green-200';
                    } else {
                        throw error;
                    }
                } catch (err) {
                    badge.innerHTML = `<span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span> Connection Lost`;
                    badge.className = 'flex items-center text-xs font-semibold text-red-600 bg-red-50 px-2.5 py-1 rounded-full border border-red-200';
                }
            }
        }

        function showLiveNotification(msg) {
            const connectedBadge = document.getElementById('live-connection');
            if (!connectedBadge) return;
            const originalContent = connectedBadge.innerHTML;

            connectedBadge.innerHTML = `<span class="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-ping"></span> ${msg}`;
            connectedBadge.classList.replace('text-green-600', 'text-yellow-600');
            connectedBadge.classList.replace('bg-green-50', 'bg-yellow-50');

            setTimeout(() => {
                connectedBadge.innerHTML = originalContent;
                connectedBadge.classList.replace('text-yellow-600', 'text-green-600');
                connectedBadge.classList.replace('bg-yellow-50', 'bg-green-50');
            }, 5000);
        }

        // Logout Function
        function logoutAdmin() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('donero_admin_auth');
                sessionStorage.removeItem('donero_admin_name');
                window.location.href = 'login.html';
            }
        }

        // Print Order Ticket Function
        function printOrderTicket(orderId) {
            const order = MOCK_ORDERS.find(o => o.id === orderId);
            if (!order) {
                alert('Order not found!');
                return;
            }

            const printFrame = document.getElementById('print-frame');
            const doc = printFrame.contentWindow.document;

            const itemsHtml = order.items.map(it => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px;">
                    <span>${it.qty}x ${it.name}</span>
                    <span>‚Çπ${(it.qty * it.price).toFixed(2)}</span>
                </div>
            `).join('');

            const receiptHtml = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Receipt-${order.id}</title>
                    <style>
                        @page { margin: 0; }
                        body { 
                            font-family: 'Courier New', Courier, monospace; 
                            width: 100%; 
                            max-width: 80mm; 
                            margin: 0; 
                            padding: 5mm; 
                            color: #000; 
                            background: #fff;
                        }
                        .header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 8px; margin-bottom: 12px; }
                        .cafe-name { font-size: 24px; font-weight: 900; margin: 0; text-transform: uppercase; }
                        .order-info { margin-bottom: 12px; font-size: 14px; line-height: 1.4; border-bottom: 1px dashed #000; padding-bottom: 8px; }
                        .items { border-bottom: 1px dashed #000; padding-bottom: 8px; margin-bottom: 8px; }
                        .item-row { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 14px; font-weight: bold; }
                        .total-section { 
                            display: flex; 
                            justify-content: space-between; 
                            font-size: 20px; 
                            font-weight: 900; 
                            margin-top: 8px;
                            padding-top: 4px;
                            border-top: 2px solid #000;
                        }
                        .footer { text-align: center; margin-top: 20px; font-size: 12px; line-height: 1.2; }
                        .qr-placeholder { margin-top: 10px; font-size: 10px; border-top: 1px solid #000; padding-top: 5px; }
                        @media print {
                            body { width: 80mm; padding: 2mm; }
                            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <p class="cafe-name">DONERO CAFE</p>
                        <p style="margin: 4px 0 0 0; font-size: 14px; font-weight: bold;">ORDER RECEIPT</p>
                    </div>
                    <div class="order-info">
                        <div style="display: flex; justify-content: space-between;">
                            <span><b>ID:</b> #${order.id}</span>
                            <span><b>DATE:</b> ${new Date().toLocaleDateString()}</span>
                        </div>
                        <div style="margin-top: 4px;"><b>TABLE:</b> ${order.table}</div>
                        <div><b>CLIENT:</b> ${order.customer}</div>
                    </div>
                    <div class="items">
                        ${itemsHtml}
                    </div>
                    <div class="total-section">
                        <span>TOTAL:</span>
                        <span>‚Çπ${order.total.toFixed(2)}</span>
                    </div>
                    <div class="footer">
                        <p><b>THANK YOU!</b><br>Visit Again at Donero Cafe</p>
                        <p style="margin-top: 10px; font-size: 10px;">System Generated Receipt</p>
                    </div>
                </body>
                </html>
            `;

            doc.open();
            doc.write(receiptHtml);
            doc.close();

            // Wait for resources to load if any, then print
            setTimeout(() => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
            }, 250);
        }
    </script>
    </div>
</body>

</html>
